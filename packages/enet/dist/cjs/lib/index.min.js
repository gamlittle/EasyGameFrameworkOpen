"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t,e,o=function(){function t(){}return t.prototype.onStartConnenct=function(t){console.log("start connect:".concat(t.url,",opt:"),t)},t.prototype.onConnectEnd=function(t,e){console.log("connect ok:".concat(t.url,",opt:"),t),console.log("handshakeRes:",e)},t.prototype.onError=function(t,e){console.error("socket error,opt:",e),console.error(t)},t.prototype.onClosed=function(t,e){console.error("socket close,opt:",e),console.error(t)},t.prototype.onStartReconnect=function(t,e){console.log("start reconnect:".concat(e.url,",opt:"),e)},t.prototype.onReconnecting=function(t,e,o){console.log("url:".concat(o.url," reconnect count:").concat(t,",less count:").concat(e.reconnectCount,",opt:"),o)},t.prototype.onReconnectEnd=function(t,e,o){console.log("url:".concat(o.url,"reconnect end ").concat(t?"ok":"fail"," ,opt:"),o)},t.prototype.onStartRequest=function(t,e){console.log("start request:".concat(t.protoKey,",id:").concat(t.reqId,",opt:"),e),console.log("reqCfg:",t)},t.prototype.onData=function(t,e){console.log("data :".concat(t.key,",opt:"),e)},t.prototype.onRequestTimeout=function(t,e){console.warn("request timeout:".concat(t.protoKey,",opt:"),e)},t.prototype.onCustomError=function(t,e){console.error("proto key:".concat(t.key,",reqId:").concat(t.reqId,",code:").concat(t.code,",errorMsg:").concat(t.errorMsg,",opt:"),e)},t.prototype.onKick=function(t,e){console.log("be kick,opt:",e)},t}();exports.PackageType=void 0,(t=exports.PackageType||(exports.PackageType={}))[t.HANDSHAKE=1]="HANDSHAKE",t[t.HANDSHAKE_ACK=2]="HANDSHAKE_ACK",t[t.HEARTBEAT=3]="HEARTBEAT",t[t.DATA=4]="DATA",t[t.KICK=5]="KICK",exports.SocketState=void 0,(e=exports.SocketState||(exports.SocketState={}))[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED";var n=function(){function t(){}return Object.defineProperty(t.prototype,"state",{get:function(){return this._sk?this._sk.readyState:exports.SocketState.CLOSED},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isConnected",{get:function(){return!!this._sk&&this._sk.readyState===exports.SocketState.OPEN},enumerable:!1,configurable:!0}),t.prototype.setEventHandler=function(t){this._eventHandler=t},t.prototype.connect=function(t){var e,o,n,r,i,s,c,a,h=t.url;if(!h){if(!t.host||!t.port)return!1;h="".concat(t.protocol?"wss":"ws","://").concat(t.host,":").concat(t.port)}t.url=h,this._sk&&this.close(!0),this._sk||(this._sk=new WebSocket(h),t.binaryType||(t.binaryType="arraybuffer"),this._sk.binaryType=t.binaryType,this._sk.onclose=(null===(e=this._eventHandler)||void 0===e?void 0:e.onSocketClosed)&&(null===(o=this._eventHandler)||void 0===o?void 0:o.onSocketClosed),this._sk.onerror=(null===(n=this._eventHandler)||void 0===n?void 0:n.onSocketError)&&(null===(r=this._eventHandler)||void 0===r?void 0:r.onSocketError),this._sk.onmessage=(null===(i=this._eventHandler)||void 0===i?void 0:i.onSocketMsg)&&(null===(s=this._eventHandler)||void 0===s?void 0:s.onSocketMsg),this._sk.onopen=(null===(c=this._eventHandler)||void 0===c?void 0:c.onSocketConnected)&&(null===(a=this._eventHandler)||void 0===a?void 0:a.onSocketConnected))},t.prototype.send=function(t){this._sk?this._sk.send(t):console.error("socket is null")},t.prototype.close=function(t){var e,o;if(this._sk){var n=this.isConnected;this._sk.close(),this._sk.onclose=null,this._sk.onerror=null,this._sk.onmessage=null,this._sk.onopen=null,this._sk=null,n&&(null===(e=this._eventHandler)||void 0===e?void 0:e.onSocketClosed)&&(null===(o=this._eventHandler)||void 0===o||o.onSocketClosed(t))}},t}(),r=function(){function t(){this._curReconnectCount=0,this._reqId=1}return Object.defineProperty(t.prototype,"socket",{get:function(){return this._socket},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"netEventHandler",{get:function(){return this._netEventHandler},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"protoHandler",{get:function(){return this._protoHandler},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"socketEventHandler",{get:function(){return this._socketEventHandler||(this._socketEventHandler={onSocketClosed:this._onSocketClosed.bind(this),onSocketConnected:this._onSocketConnected.bind(this),onSocketError:this._onSocketError.bind(this),onSocketMsg:this._onSocketMsg.bind(this)}),this._socketEventHandler},enumerable:!1,configurable:!0}),t.prototype.init=function(t){if(!this._inited){this._protoHandler=t&&t.protoHandler?t.protoHandler:new i,this._socket=t&&t.socket?t.socket:new n,this._netEventHandler=t&&t.netEventHandler?t.netEventHandler:new o,this._pushHandlerMap={},this._oncePushHandlerMap={},this._reqCfgMap={};var e=t&&t.reConnectCfg;e?(this._reConnectCfg=e,isNaN(e.reconnectCount)&&(this._reConnectCfg.reconnectCount=4),isNaN(e.connectTimeout)&&(this._reConnectCfg.connectTimeout=6e4)):this._reConnectCfg={reconnectCount:4,connectTimeout:6e4},this._gapThreashold=t&&!isNaN(t.heartbeatGapThreashold)?t.heartbeatGapThreashold:100,this._useCrypto=t&&t.useCrypto,this._inited=!0,this._socket.setEventHandler(this.socketEventHandler),this._pkgTypeHandlers={},this._pkgTypeHandlers[exports.PackageType.HANDSHAKE]=this._onHandshake.bind(this),this._pkgTypeHandlers[exports.PackageType.HEARTBEAT]=this._heartbeat.bind(this),this._pkgTypeHandlers[exports.PackageType.DATA]=this._onData.bind(this),this._pkgTypeHandlers[exports.PackageType.KICK]=this._onKick.bind(this)}},t.prototype.connect=function(t,e){var o=this._socket,n=o&&(o.state===exports.SocketState.CLOSING||o.state===exports.SocketState.CLOSED);if(this._inited&&n){"string"==typeof t&&(t={url:t,connectEnd:e}),e&&(t.connectEnd=e),this._connectOpt=t,this._socket.connect(t);var r=this._netEventHandler;r.onStartConnenct&&r.onStartConnenct(t)}else console.error("is not inited".concat(o?" , socket state"+o.state:""))},t.prototype.disConnect=function(){this._socket.close(!0),this._heartbeatTimeId&&(clearTimeout(this._heartbeatTimeId),this._heartbeatTimeId=void 0),this._heartbeatTimeoutId&&(clearTimeout(this._heartbeatTimeoutId),this._heartbeatTimeoutId=void 0)},t.prototype.reConnect=function(){var t=this;if(this._inited&&this._socket)if(this._curReconnectCount>this._reConnectCfg.reconnectCount)this._stopReconnect(!1);else{if(!this._isReconnecting){var e=this._netEventHandler;e.onStartReconnect&&e.onStartReconnect(this._reConnectCfg,this._connectOpt)}this._isReconnecting=!0,this.connect(this._connectOpt),this._curReconnectCount++;var o=this._netEventHandler;o.onReconnecting&&o.onReconnecting(this._curReconnectCount,this._reConnectCfg,this._connectOpt),this._reconnectTimerId=setTimeout((function(){t.reConnect()}),this._reConnectCfg.connectTimeout)}},t.prototype.request=function(t,e,o,n){if(this._isSocketReady()){var r=this._reqId,i=this._protoHandler,s=i.encodeMsg({key:t,reqId:r,data:e},this._useCrypto);if(s){var c={reqId:r,protoKey:i.protoKey2Key(t),data:e,resHandler:o};n&&(c=Object.assign(c,n)),this._reqCfgMap[r]=c,this._reqId++,this._netEventHandler.onStartRequest&&this._netEventHandler.onStartRequest(c,this._connectOpt),this.send(s)}}},t.prototype.notify=function(t,e){if(this._isSocketReady()){var o=this._protoHandler.encodeMsg({key:t,data:e},this._useCrypto);this.send(o)}},t.prototype.send=function(t){this._socket.send(t)},t.prototype.onPush=function(t,e){var o=this._protoHandler.protoKey2Key(t);this._pushHandlerMap[o]?this._pushHandlerMap[o].push(e):this._pushHandlerMap[o]=[e]},t.prototype.oncePush=function(t,e){var o=this._protoHandler.protoKey2Key(t);this._oncePushHandlerMap[o]?this._oncePushHandlerMap[o].push(e):this._oncePushHandlerMap[o]=[e]},t.prototype.offPush=function(t,e,o,n){var r,i=this._protoHandler.protoKey2Key(t);if(r=n?this._oncePushHandlerMap[i]:this._pushHandlerMap[i])for(var s=void 0,c=void 0,a=r.length-1;a>-1;a--)c=!1,"function"==typeof(s=r[a])&&s===e?c=!0:"object"!=typeof s||s.method!==e||o&&o!==s.context||(c=!0),c&&(a!==r.length&&(r[a]=r[r.length-1],r[r.length-1]=s),r.pop())},t.prototype.offPushAll=function(t){if(t){var e=this._protoHandler.protoKey2Key(t);delete this._pushHandlerMap[e],delete this._oncePushHandlerMap[e]}else this._pushHandlerMap={},this._oncePushHandlerMap={}},t.prototype._onHandshake=function(t){if(!t.errorMsg){this._handshakeInit(t);var e=this._protoHandler.encodePkg({type:exports.PackageType.HANDSHAKE_ACK});this.send(e);var o=this._connectOpt,n=this._protoHandler.handShakeRes;o.connectEnd&&o.connectEnd(n),this._netEventHandler.onConnectEnd&&this._netEventHandler.onConnectEnd(o,n)}},t.prototype._handshakeInit=function(t){var e=this.protoHandler.heartbeatConfig;this._heartbeatConfig=e},t.prototype._heartbeat=function(t){var e=this,o=this._heartbeatConfig,n=this._protoHandler;o&&o.heartbeatInterval&&(this._heartbeatTimeoutId&&(clearTimeout(this._heartbeatTimeoutId),this._heartbeatTimeoutId=void 0),this._heartbeatTimeId=setTimeout((function(){e._heartbeatTimeId=void 0;var t=n.encodePkg({type:exports.PackageType.HEARTBEAT},e._useCrypto);e.send(t),e._nextHeartbeatTimeoutTime=Date.now()+o.heartbeatTimeout,e._heartbeatTimeoutId=setTimeout(e._heartbeatTimeoutCb.bind(e),o.heartbeatTimeout)}),o.heartbeatInterval))},t.prototype._heartbeatTimeoutCb=function(){var t=this._nextHeartbeatTimeoutTime-Date.now();t>this._gapThreashold?this._heartbeatTimeoutId=setTimeout(this._heartbeatTimeoutCb.bind(this),t):(console.error("server heartbeat timeout"),this.disConnect())},t.prototype._onData=function(t){if(!t.errorMsg){var e;if(!isNaN(t.reqId)&&t.reqId>0){var o=t.reqId;if(!(e=this._reqCfgMap[o]))return;e.decodePkg=t,this._runHandler(e.resHandler,t)}else{var n=t.key,r=this._pushHandlerMap[n],i=this._oncePushHandlerMap[n];if(r?i&&(r=r.concat(i)):r=i,delete this._oncePushHandlerMap[n],r)for(var s=0;s<r.length;s++)this._runHandler(r[s],t)}var c=this._netEventHandler;c.onData&&c.onData(t,this._connectOpt,e)}},t.prototype._onKick=function(t){this._netEventHandler.onKick&&this._netEventHandler.onKick(t,this._connectOpt)},t.prototype._isSocketReady=function(){var t=this._socket,e=t&&(t.state===exports.SocketState.CONNECTING||t.state===exports.SocketState.OPEN);return!(!this._inited||!e)||(console.error("".concat(this._inited?e?"socket is ready":"socket is null or unready":"netNode is unInited")),!1)},t.prototype._onSocketConnected=function(t){if(this._isReconnecting)this._stopReconnect();else{var e=this._netEventHandler,o=this._connectOpt,n=this._protoHandler;if(n&&o.handShakeReq){var r=n.encodePkg({type:exports.PackageType.HANDSHAKE,data:o.handShakeReq});this.send(r)}else o.connectEnd&&o.connectEnd(),e.onConnectEnd&&e.onConnectEnd(o)}},t.prototype._onSocketError=function(t){var e=this._netEventHandler;e.onError&&e.onError(t,this._connectOpt)},t.prototype._onSocketMsg=function(t){var e=this._protoHandler.decodePkg(t.data),o=this._netEventHandler,n=this._pkgTypeHandlers[e.type];n?n(e):console.error("There is no handler of this type:".concat(e.type)),e.errorMsg&&o.onCustomError&&o.onCustomError(e,this._connectOpt),this._nextHeartbeatTimeoutTime&&(this._nextHeartbeatTimeoutTime=Date.now()+this._heartbeatConfig.heartbeatTimeout)},t.prototype._onSocketClosed=function(t){var e=this._netEventHandler;this._isReconnecting?(clearTimeout(this._reconnectTimerId),this.reConnect()):e.onClosed&&e.onClosed(t,this._connectOpt)},t.prototype._runHandler=function(t,e){"function"==typeof t?t(e):"object"==typeof t&&t.method&&t.method.apply(t.context,t.args?[e].concat(t.args):[e])},t.prototype._stopReconnect=function(t){if(void 0===t&&(t=!0),this._isReconnecting){this._isReconnecting=!1,clearTimeout(this._reconnectTimerId),this._curReconnectCount=0;var e=this._netEventHandler;e.onReconnectEnd&&e.onReconnectEnd(t,this._reConnectCfg,this._connectOpt)}},t}(),i=function(){function t(){}return Object.defineProperty(t.prototype,"handShakeRes",{get:function(){},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"heartbeatConfig",{get:function(){return this._heartbeatCfg},enumerable:!1,configurable:!0}),t.prototype.encodePkg=function(t,e){return JSON.stringify(t)},t.prototype.protoKey2Key=function(t){return t},t.prototype.encodeMsg=function(t,e){return JSON.stringify({type:exports.PackageType.DATA,data:t})},t.prototype.decodePkg=function(t){var e=JSON.parse(t),o=e.type;if(e.type===exports.PackageType.DATA){var n=e.data;return{key:n&&n.key,type:o,data:n.data,reqId:e.data&&e.data.reqId}}return o===exports.PackageType.HANDSHAKE&&(this._heartbeatCfg=e.data),{type:o,data:e.data}},t}();exports.DefaultNetEventHandler=o,exports.NetNode=r,exports.WSocket=n;
